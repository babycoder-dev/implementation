# 学习管理系统 - 任务管理模块需求规格

## 文档信息

| 项目 | 内容 |
|-----|------|
| 文档名称 | 任务管理模块 - 详细规格 |
| 版本 | v1.0 |
| 状态 | 已确认 |
| 所属模块 | 模块二 |

---

## 目录

1. [功能概述](#1-功能概述)
2. [用户界面](#2-用户界面)
3. [API 接口](#3-api-接口)
4. [数据模型](#4-数据模型)
5. [业务规则](#5-业务规则)

---

## 1. 功能概述

### 1.1 模块目标

提供学习任务的完整管理能力，包括任务的创建、编辑、删除、文件上传、任务分配等功能。

### 1.2 核心功能清单

| 功能 | 优先级 | 描述 |
|-----|-------|------|
| 任务列表查看 | P0 | 列出所有学习任务 |
| 创建任务 | P0 | 新建学习任务（包含文件上传） |
| 编辑任务 | P1 | 修改任务信息 |
| 删除任务 | P1 | 删除任务 |
| 上传学习文件 | P0 | 上传 PDF/视频/Office 文件 |
| 管理任务文件 | P0 | 文件列表、排序、删除 |
| 任务分配 | P0 | 分配给用户或部门 |
| 管理测验题目 | P1 | 添加/编辑/删除测验题目 |
| 任务详情查看 | P0 | 查看任务完整信息 |

### 1.3 优先级说明

| 优先级 | 说明 |
|-------|------|
| P0 | 核心功能，必须实现 |
| P1 | 重要功能，应该实现 |
| P2 | 增强功能，可以后续实现 |

---

## 2. 用户界面

### 2.1 任务列表页面

**页面路径**：`/admin/tasks`

**页面布局**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  学习任务管理                                                          │
├─────────────────────────────────────────────────────────────────────┤
│  [新建任务]                                                            │
├─────────────────────────────────────────────────────────────────────┤
│  [搜索任务名称...]                          [状态 ▼]  [筛选]         │
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────┬──────────┬─────────┬──────────┬────────┬─────────────┐ │
│  │ 任务名 │ 描述摘要  │ 文件数  │ 分配范围 │ 截止日期 │ 状态 │ 操作  │ │
│  ├────────┼──────────┼─────────┼──────────┼────────┼─────────────┤ │
│  │ 新员工 │ 入职培训  │ 3       │ 全体员工 │ 2024-01 │ 已发布 │ 编辑 │ │
│  │ 培训   │ 包含PDF  │         │          │ 31     │          删除 │ │
│  │        │ 视频      │         │          │        │          查看 │ │
│  ├────────┼──────────┼─────────┼──────────┼────────┼─────────────┤ │
│  │ 安全规范│ 安全知识  │ 2       │ 生产部   │ 2024-02 │ 草稿    │ ...  │ │
│  │ 培训   │          │         │          │ 15     │          查看 │ │
│  └────────┴──────────┴─────────┴──────────┴────────┴─────────────┘ │
├─────────────────────────────────────────────────────────────────────┤
│  [首页] [上一页] 1 2 3 [下一页] [末页]                        共 10 条 │
└─────────────────────────────────────────────────────────────────────┘
```

**功能说明**：

| 功能 | 说明 |
|-----|------|
| 新建任务按钮 | 打开创建任务页面 |
| 搜索框 | 按任务名称搜索 |
| 状态筛选 | 全部/草稿/已发布/已完成/已归档 |
| 操作-编辑 | 进入任务编辑页面 |
| 操作-删除 | 删除任务（需二次确认） |
| 操作-查看 | 进入任务详情页面 |

**列表字段说明**：

| 字段 | 说明 |
|-----|------|
| 任务名 | 任务标题，超长省略 |
| 描述摘要 | 任务描述前50字符，省略号 |
| 文件数 | 该任务包含的文件数量 |
| 分配范围 | 全体员工/指定部门名称 |
| 截止日期 | 格式 YYYY-MM-DD，无截止日期显示"-" |
| 状态 | 草稿/已发布/已完成/已归档 |
| 操作 | 下拉菜单：编辑、删除、查看 |

---

### 2.2 创建/编辑任务页面

**页面路径**：
- 创建：`/admin/tasks/create`
- 编辑：`/admin/tasks/[id]/edit`

**完整表单布局**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  创建学习任务                                                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  第一步：基本信息                                                  ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │                                                                      ││
│  │  任务名称 *                                                      ││
│  │  ┌─────────────────────────────────────────────────────────────┐ ││
│  │  │                                                             │ ││
│  │  │                                                             │ ││
│  │  └─────────────────────────────────────────────────────────────┘ ││
│  │                                                                      ││
│  │  任务描述                                                        ││
│  │  ┌─────────────────────────────────────────────────────────────┐ ││
│  │  │                                                             │ ││
│  │  │                                                             │ ││
│  │  │                                                             │ ││
│  │  └─────────────────────────────────────────────────────────────┘ ││
│  │                                                                      ││
│  │  截止日期                                                        ││
│  │  ┌─────────────────────────────┐                                  ││
│  │  │ 📅 2024-01-31            │                                  ││
│  │  └─────────────────────────────┘                                  ││
│  │                                                                      ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  第二步：分配范围                                                  ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │                                                                      ││
│  │  ┌────────────────────────────┐ ┌────────────────────────────┐   ││
│  │  │ ○ 全体员工                 │ │ 部门/用户选择               │   ││
│  │  │ ● 指定部门/用户           │ │ ☑ 技术部                  │   ││
│  │  └────────────────────────────┘ │   ☑ 市场部                  │   ││
│  │                                   │   ☐ 用户A (技术部)          │   ││
│  │                                   │   ☐ 用户B (市场部)          │   ││
│  │                                   └────────────────────────────┘   ││
│  │                                                                      ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  第三步：上传学习文件                                              ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │                                                                      ││
│  │  ┌─────────────────────────────────────────────────────────────┐  ││
│  │  │              📁 拖拽文件到此处，或点击选择                  │  ││
│  │  │         支持 PDF、视频、Office 文档 | 单文件最大 500MB       │  ││
│  │  │                                                              │  ││
│  │  │                         [ 选择文件 ]                         │  ││
│  │  └─────────────────────────────────────────────────────────────┘  ││
│  │                                                                      ││
│  │  已上传文件 (3)                                                    ││
│  │  ─────────────────────────────────────────────────────────────   ││
│  │  ┌─────────────────────────────────────────────────────────────┐ ││
│  │  │ [⋮⋮] [PDF]  公司介绍.pdf        1.2 MB     👁️  🗑️       │ ││
│  │  └─────────────────────────────────────────────────────────────┘ ││
│  │  ┌─────────────────────────────────────────────────────────────┐ ││
│  │  │ [⋮⋮] [视频] 安全规范视频.mp4     45.6 MB     👁️  🗑️       │ ││
│  │  └─────────────────────────────────────────────────────────────┘ ││
│  │  ┌─────────────────────────────────────────────────────────────┐ ││
│  │  │ [⋮⋮] [PDF]  工作流程.pdf        2.1 MB     👁️  🗑️       │ ││
│  │  └─────────────────────────────────────────────────────────────┘ ││
│  │                         [ + 添加更多文件 ]                         ││
│  │                                                                      ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  第四步：测验设置（可选）                                          ││
│  ├─────────────────────────────────────────────────────────────────┤│
│  │                                                                      ││
│  │  ┌─────────────────────────────────────────────────────────────┐  ││
│  │  │ ☑ 启用测验考核                                                │  ││
│  │  └─────────────────────────────────────────────────────────────┘  ││
│  │                                                                      ││
│  │  ──────────────────────────────────────────────────────────────    ││
│  │                                                                      ││
│  │  及格分数                                                         ││
│  │  ┌─────────────────────────────┐                                  ││
│  │  │ 60                         │  %                               ││
│  │  └─────────────────────────────┘                                  ││
│  │                                                                      ││
│  │  ──────────────────────────────────────────────────────────────    ││
│  │                                                                      ││
│  │  及格规则                                                         ││
│  │  ┌────────────────────────────┐                                  ││
│  │  │ ○ 必须全部答对（严格模式） │                                  ││
│  │  │ ● 达到及格分数即可        │                                  ││
│  │  └────────────────────────────┘                                  ││
│  │                                                                      ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                        [ 取消 ]          [ 保存草稿 ]  [ 发布任务 ] │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

**表单分步说明**：

| 步骤 | 名称 | 必填 | 说明 |
|-----|------|-----|------|
| 1 | 基本信息 | 是 | 任务名称、描述、截止日期 |
| 2 | 分配范围 | 是 | 全体/指定部门/指定用户 |
| 3 | 上传学习文件 | 是 | 至少上传1个文件 |
| 4 | 测验设置 | 否 | 可选启用 |

**表单验证规则**：

| 字段 | 规则 |
|-----|------|
| 任务名称 | 1-200字符，必填 |
| 任务描述 | 最多2000字符 |
| 截止日期 | 可选，格式 YYYY-MM-DD |
| 分配范围 | 至少选择一项 |
| 学习文件 | 至少上传1个，支持 PDF/视频/Office |
| 及格分数 | 0-100，仅启用测验时显示 |
| 及格规则 | 严格模式/分数模式二选一 |

---

### 2.3 任务详情页面

**页面路径**：`/admin/tasks/[id]`

**页面布局**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  任务详情：新员工入职培训                                             │
├─────────────────────────────────────────────────────────────────────┤
│  [编辑] [删除] [返回列表]                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  基本信息                              测验设置                   │ │
│  │  ─────────────────                   ─────────────────         │ │
│  │  状态：已发布                         ☑ 启用测验                 │ │
│  │  创建时间：2024-01-15 10:30          及格分数：60分             │ │
│  │  截止日期：2024-01-31                题目数量：5题               │ │
│  │  完成人数：12/50                      严格模式：☑                 │ │
│  │  创建人：管理员                                                  │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                      学习文件 (共 3 个)                           │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │  排序 │ 文件类型 │ 文件名称           │ 大小     │ 操作          │ │
│  ├──────┼──────────┼────────────────────┼──────────┼──────────────┤ │
│  │  1   │ [PDF]    │ 公司介绍.pdf       │ 1.2 MB   │ [预览] [删除]│ │
│  │  2   │ [视频]   │ 安全规范视频.mp4   │ 45.6 MB  │ [预览] [删除]│ │
│  │  3   │ [PDF]    │ 工作流程.pdf       │ 2.1 MB   │ [预览] [删除]│ │
│  │      │          │                    │          │ [+ 添加文件] │ │
│  └──────┴──────────┴────────────────────┴──────────┴──────────────┘ │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                      测验题目 (共 5 题)                          │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │  1. 公司成立于哪一年？                                            │ │
│  │     A. 2010  B. 2015  C. 2018  D. 2020                         │ │
│  │  2. 公司的核心价值观是？                                          │ │
│  │     ...                                                         │ │
│  │                                              [+ 添加题目]         │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                      分配情况                                    │ │
│  ├─────────────────────────────────────────────────────────────────┤ │
│  │  部门：全体员工                    │  应学：50人  已学：12人        │ │
│  │                                                                      │
│  │  查看分配名单  [+ 添加分配对象]                                   │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 2.4 文件上传组件

**文件列表项设计**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  文件信息行设计                                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌───────┬──────────────┬───────────────┬───────────┬──────────┐   │
│  │  ⋮⋮  │ [文件类型    │ 文件名称      │ 文件大小  │  操作    │   │
│  │  拖拽 │ 图标标识]    │               │          │          │   │
│  └───────┴──────────────┴───────────────┴───────────┴──────────┘   │
│                                                                      │
│  说明：                                                               │
│  - 拖拽图标：支持拖拽排序                                              │
│  - 文件类型标识：根据文件类型显示不同图标和颜色                         │
│    • PDF：红色 [PDF] 标签                                             │
│    • 视频：蓝色 [视频] 标签                                           │
│    • Office：绿色 [文档] / [表格] / [幻灯片] 标签                    │
│  - 文件名称：显示文件名，可编辑                                        │
│  - 文件大小：自动格式化 (KB/MB/GB)                                     │
│  - 操作：预览、删除                                                   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**支持的配置项**：

| 配置项 | 说明 |
|-------|------|
| 拖拽上传 | 支持将文件拖入上传区域 |
| 批量上传 | 支持同时选择多个文件 |
| 文件类型验证 | 上传前验证文件类型 |
| 大小限制 | 单文件最大 500MB |
| 排序功能 | 拖拽调整文件顺序 |
| 预览功能 | 上传后立即预览 |
| 删除功能 | 移除已上传文件 |
| 进度显示 | 显示上传进度百分比 |

**上传状态指示**：

| 状态 | 显示效果 |
|-----|---------|
| 上传中 | [████████....] 45% |
| 上传成功 | ✅ 文件名 尺寸 |
| 上传失败 | ❌ 文件名 重试 |
| 转换中 | ⏳ 文件名 正在转换... |
| 转换完成 | ✅ 文件名 已转换完成 |

---

## 3. API 接口

### 3.1 任务相关接口

#### 3.1.1 获取任务列表

**接口**：`GET /api/tasks`

**请求参数**：

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页数量，默认10 |
| status | string | 否 | 状态筛选 |
| search | string | 否 | 搜索关键词 |

**响应示例**：

```json
{
  "success": true,
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "新员工入职培训",
      "description": "帮助新员工快速了解公司文化和工作流程",
      "status": "published",
      "deadline": "2024-01-31T23:59:59Z",
      "passing_score": 60,
      "strict_mode": true,
      "file_count": 3,
      "assignment_count": 50,
      "created_at": "2024-01-15T10:30:00Z"
    }
  ],
  "meta": {
    "total": 10,
    "page": 1,
    "limit": 10,
    "totalPages": 1
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.1.2 获取任务详情

**接口**：`GET /api/tasks/[id]`

**响应示例**：

```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "新员工入职培训",
    "description": "帮助新员工快速了解公司文化和工作流程",
    "status": "published",
    "deadline": "2024-01-31T23:59:59Z",
    "passing_score": 60,
    "strict_mode": true,
    "enable_quiz": true,
    "created_by": {
      "id": "user-uuid",
      "name": "管理员"
    },
    "files": [
      {
        "id": "file-uuid",
        "title": "公司介绍.pdf",
        "file_type": "pdf",
        "file_size": 1258291,
        "duration": null,
        "order": 1,
        "converted": true
      }
    ],
    "assignments": [
      {
        "user_id": "user-uuid",
        "user_name": "张三",
        "department_name": "技术部",
        "assigned_at": "2024-01-15T10:30:00Z",
        "is_completed": false
      }
    ],
    "quiz_questions": [
      {
        "id": "question-uuid",
        "question": "公司成立于哪一年？",
        "options": ["2010", "2015", "2018", "2020"],
        "correct_answer": 2,
        "order": 1
      }
    ],
    "created_at": "2024-01-15T10:30:00Z"
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.1.3 创建任务

**接口**：`POST /api/tasks`

**请求体**：

```json
{
  "title": "新员工入职培训",
  "description": "帮助新员工快速了解公司",
  "deadline": "2024-01-31T23:59:59Z",
  "assignment_type": "department",
  "assignment_ids": ["dept-uuid-1", "dept-uuid-2"],
  "enable_quiz": true,
  "passing_score": 60,
  "strict_mode": true
}
```

**响应**：

```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000"
  },
  "meta": {
    "message": "任务创建成功"
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.1.4 更新任务

**接口**：`PUT /api/tasks/[id]`

**请求体**（可选字段）：

```json
{
  "title": "新员工入职培训（2024版）",
  "description": "更新后的描述",
  "deadline": "2024-02-28T23:59:59Z",
  "status": "published",
  "enable_quiz": false
}
```

#### 3.1.5 删除任务

**接口**：`DELETE /api/tasks/[id]`

**响应**：

```json
{
  "success": true,
  "meta": {
    "message": "任务删除成功"
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

---

### 3.2 文件相关接口

#### 3.2.1 上传文件

**接口**：`POST /api/tasks/[id]/files`

**请求**：multipart/form-data

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| file | File | 是 | 上传的文件 |
| title | string | 否 | 文件标题（默认文件名） |
| order | number | 否 | 排序序号 |
| required_completion | string | 否 | 完成条件（默认last_page） |

**响应**：

```json
{
  "success": true,
  "data": {
    "id": "file-uuid",
    "title": "公司介绍.pdf",
    "file_url": "/uploads/tasks/xxx/intro.pdf",
    "file_type": "pdf",
    "file_size": 1258291,
    "duration": null,
    "order": 1,
    "converted": true
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.2.2 获取文件列表

**接口**：`GET /api/tasks/[id]/files`

**响应**：

```json
{
  "success": true,
  "data": [
    {
      "id": "file-uuid",
      "title": "公司介绍.pdf",
      "file_type": "pdf",
      "file_size": 1258291,
      "order": 1,
      "converted": true
    }
  ],
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.2.3 删除文件

**接口**：`DELETE /api/tasks/[id]/files/[fileId]`

#### 3.2.4 更新文件排序

**接口**：`PUT /api/tasks/[id]/files/order`

**请求体**：

```json
{
  "file_ids": ["file-uuid-1", "file-uuid-2", "file-uuid-3"]
}
```

---

### 3.3 任务分配接口

#### 3.3.1 获取分配列表

**接口**：`GET /api/tasks/[id]/assignments`

**响应**：

```json
{
  "success": true,
  "data": {
    "assignment_type": "department",
    "assignments": [
      {
        "user_id": "user-uuid",
        "user_name": "张三",
        "department_name": "技术部",
        "assigned_at": "2024-01-15T10:30:00Z",
        "is_completed": false
      }
    ]
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.3.2 添加分配

**接口**：`POST /api/tasks/[id]/assignments`

**请求体**：

```json
{
  "assignment_type": "department",
  "ids": ["dept-uuid-1", "dept-uuid-2"]
}
```

或

```json
{
  "assignment_type": "user",
  "ids": ["user-uuid-1", "user-uuid-2"]
}
```

#### 3.3.3 移除分配

**接口**：`DELETE /api/tasks/[id]/assignments`

**请求体**：

```json
{
  "user_ids": ["user-uuid-1", "user-uuid-2"]
}
```

---

### 3.4 测验题目接口

#### 3.4.1 获取题目列表

**接口**：`GET /api/tasks/[id]/quiz`

**响应**：

```json
{
  "success": true,
  "data": {
    "enable_quiz": true,
    "passing_score": 60,
    "strict_mode": true,
    "questions": [
      {
        "id": "question-uuid",
        "question": "公司成立于哪一年？",
        "options": ["2010", "2015", "2018", "2020"],
        "correct_answer": 2,
        "order": 1
      }
    ]
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.4.2 添加题目

**接口**：`POST /api/tasks/[id]/quiz`

**请求体**：

```json
{
  "question": "公司成立于哪一年？",
  "options": ["2010", "2015", "2018", "2020"],
  "correct_answer": 2,
  "order": 1
}
```

#### 3.4.3 更新题目

**接口**：`PUT /api/tasks/[id]/quiz/[questionId]`

#### 3.4.4 删除题目

**接口**：`DELETE /api/tasks/[id]/quiz/[questionId]`

---

### 3.5 错误码说明

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误（必填项缺失、格式错误） |
| 401 | 未登录或登录已过期 |
| 403 | 无权限操作 |
| 404 | 任务/文件/题目不存在 |
| 409 | 任务名称重复或文件已存在 |
| 500 | 服务器内部错误 |

---

## 4. 数据模型

### 4.1 tasks 表

```sql
CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(200) NOT NULL,
  description TEXT,
  deadline TIMESTAMP,
  status VARCHAR(20) NOT NULL DEFAULT 'draft',
  passing_score INT DEFAULT 100,
  strict_mode BOOLEAN DEFAULT TRUE,
  enable_quiz BOOLEAN DEFAULT FALSE,
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP
);

CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_created_by ON tasks(created_by);
CREATE INDEX idx_tasks_deadline ON tasks(deadline);
```

### 4.2 task_files 表

```sql
CREATE TABLE task_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  title VARCHAR(200) NOT NULL,
  file_url VARCHAR(500) NOT NULL,
  original_url VARCHAR(500),
  file_type VARCHAR(20) NOT NULL,
  file_size BIGINT NOT NULL,
  duration INT,
  required_completion VARCHAR(20) DEFAULT 'last_page',
  "order" INT NOT NULL DEFAULT 0,
  converted BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_task_files_task_id ON task_files(task_id);
CREATE INDEX idx_task_files_order ON task_files(task_id, "order");
```

### 4.3 task_assignments 表

```sql
CREATE TABLE task_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  assignment_type VARCHAR(20) NOT NULL,
  assigned_by UUID REFERENCES users(id),
  assigned_at TIMESTAMP NOT NULL DEFAULT NOW(),
  submitted_at TIMESTAMP,
  is_completed BOOLEAN NOT NULL DEFAULT FALSE,
  UNIQUE(task_id, user_id)
);

CREATE INDEX idx_task_assignments_task_id ON task_assignments(task_id);
CREATE INDEX idx_task_assignments_user_id ON task_assignments(user_id);
CREATE INDEX idx_task_assignments_status ON task_assignments(is_completed);
```

### 4.4 quiz_questions 表

```sql
CREATE TABLE quiz_questions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  question TEXT NOT NULL,
  options JSONB NOT NULL,
  correct_answer INT NOT NULL,
  "order" INT NOT NULL DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_quiz_questions_task_id ON quiz_questions(task_id);
CREATE INDEX idx_quiz_questions_order ON quiz_questions(task_id, "order");
```

---

## 5. 业务规则

### 5.1 任务状态流转

```
┌─────────────────────────────────────────────────────────────────┐
│                         任务状态流转图                           │
└─────────────────────────────────────────────────────────────────┘

  ┌─────────┐                              ┌─────────┐
  │  草稿   │─── [发布] ───▶              │  已发布  │
  └─────────┘              │              └────┬────┘
                           │                   │
                           │                   │─── [时间超过截止日期] ───▶
                           │                   │
                          │               ┌────▼────┐
                          │               │  已截止  │
                          │               └────┬────┘
                          │                    │
                          │                    │─── [归档] ───▶
                          │                    │
  ┌─────────┐              │               ┌────▼────┐
  │  已删除  │◀── [删除] ───┤               │  已归档  │
  └─────────┘              │               └─────────┘
                           │
                           │─── [恢复] ───▶
```

| 状态 | 说明 | 可执行操作 |
|-----|------|-----------|
| draft（草稿） | 任务创建中，未发布 | 编辑、发布、删除 |
| published（已发布） | 任务已发布，学员可见 | 编辑、归档、删除 |
| deadline_passed（已截止） | 已超过截止日期 | 查看、归档 |
| archived（已归档） | 任务已归档，仅查看 | 查看、删除 |
| deleted（已删除） | 任务已删除 | 恢复、永久删除 |

### 5.2 文件上传规则

| 规则 | 说明 |
|-----|------|
| 文件类型限制 | 仅支持 PDF、视频、Office 文档 |
| 文件大小限制 | 单个文件最大 500MB |
| 存储位置 | 上传后存储至 MinIO，返回访问 URL |
| 文件转换 | PDF/Office 文件自动转换为浏览器可读格式 |
| 重复文件 | 同名文件允许上传，自动重命名 |

### 5.3 分配规则

| 规则 | 说明 |
|-----|------|
| 分配类型 | 支持分配给部门（部门下所有用户）或指定用户 |
| 重复分配 | 同一任务-用户组合唯一约束 |
| 批量分配 | 支持一次性分配给多个部门/用户 |
| 分配变更 | 新分配的用户立即可见任务 |

---

## 附录

### 相关文档

| 文档名称 | 描述 |
|---------|------|
| SRS-01-总体规格.md | 项目总体规格文档 |
| SRS-03-学习追踪.md | 学习追踪模块详细规格 |
| SRS-04-用户认证.md | 用户与认证模块详细规格 |
| SRS-05-测验考核.md | 测验考核模块详细规格 |
| SRS-06-报表统计.md | 报表统计模块详细规格 |
| UI-DESIGN.md | UI/UX 设计规范 |
