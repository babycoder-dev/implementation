# 企业内部学习管理系统 - 设计文档

**日期**: 2026-02-03
**版本**: 1.0

---

## 一、需求概述

在企业内部组织文件学习时，经常有成员因出差等原因错过学习。需要一个网页应用，实现：

- 管理员上传学习文件、设置学习要求、查看学习情况
- 普通用户在线学习文件
- 系统检测并记录用户真实学习行为

---

## 二、关键约束

| 约束项 | 要求 |
|--------|------|
| 用户规模 | 小型团队（50人以下） |
| 部署方式 | 内网私有部署 |
| 客户端兼容 | Windows 7 + Chrome 109 |
| 文件类型 | PDF、Office 文档、视频 |
| 用户管理 | 手动创建账号 |
| 学习检测 | 在线测试 + 行为追踪 |
| 通知方式 | 应用内通知 |
| 任务特点 | 一个任务可包含多个文件 |

---

## 三、系统架构

采用经典的 **B/S 三层架构**：

```
┌─────────────────────────────────────────────────────────┐
│                      前端层                               │
│              Next.js + React + TypeScript                │
│         Chrome 109 兼容 (Babel + Core-js)                │
└─────────────────────────────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────┐
│                      业务层                               │
│          Next.js API Routes / Server Actions             │
│      业务逻辑、权限校验、数据验证                         │
└─────────────────────────────────────────────────────────┘
                           ▼
┌─────────────────────┬───────────────────┬─────────────────┐
│    PostgreSQL       │      MinIO        │   LibreOffice   │
│   (数据持久化)      │   (文件存储)      │  (Office转PDF)  │
└─────────────────────┴───────────────────┴─────────────────┘
```

---

## 四、功能模块划分

### 4.1 管理员端

| 模块 | 功能 |
|------|------|
| 用户管理 | 增删改查用户账号，分配角色 |
| 课程管理 | 上传文件、设置学习要求（截止时间、必学人员） |
| 文档转换 | 自动将 Office 文档转为 PDF，供在线预览 |
| 题目管理 | 为每个任务创建测试题，设置及格分数 |
| 数据看板 | 查看团队学习进度统计、个人学习详情 |

### 4.2 用户端

| 模块 | 功能 |
|------|------|
| 学习任务 | 查看分配的学习任务、截止时间、完成状态 |
| 在线学习 | 阅读 PDF、观看视频，系统记录学习时长和进度 |
| 在线测试 | 学习完成后答题，系统自动判分 |
| 学习记录 | 查看个人历史学习记录和成绩 |

---

## 五、数据库设计

### 5.1 数据表

| 表名 | 主要字段 | 说明 |
|------|---------|------|
| `users` | id, username, password_hash, name, role, created_at | 用户表，role: admin/user |
| `tasks` | id, title, description, deadline, created_by, created_at | 学习任务表 |
| `task_files` | id, task_id, title, file_url, file_type, file_size, order | 任务文件表，一个任务多个文件 |
| `task_assignments` | id, task_id, user_id, assigned_at | 任务分配表，哪些用户必学该任务 |
| `quiz_questions` | id, task_id, question, options, correct_answer | 题目表，题目属于整个任务 |
| `quiz_answers` | id, user_id, question_id, answer, is_correct | 答题记录 |
| `learning_logs` | id, user_id, file_id, page_num, timestamp, action_type | PDF 学习日志，关联到具体文件 |
| `video_progress` | id, user_id, file_id, current_time, duration, last_updated | 视频播放进度，关联到具体文件 |
| `video_logs` | id, user_id, file_id, timestamp, action, current_time | 视频操作日志，关联到具体文件 |

### 5.2 关键关系

```
users (1) ──< (N) task_assignments >── (1) tasks (1) ──< (N) task_files
  │                                                       │
  └──────────< learning_logs ────────────────────────────┘
  └──────────< video_progress ───────────────────────────┘
  └──────────< video_logs ───────────────────────────────┘
  └──────────< quiz_answers ──────────< quiz_questions ──┘
```

---

## 六、技术栈选型

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 前端框架 | Next.js | 14.x | App Router，SSR 支持 |
| UI 组件 | shadcn/ui | latest | 基于 Radix UI，样式可定制 |
| 样式方案 | Tailwind CSS | 3.x | 原子化 CSS，开发效率高 |
| 状态管理 | React Context + Hooks | - | 小型场景足够 |
| 数据库 | PostgreSQL | 15.x | 成熟稳定 |
| ORM | Drizzle ORM | latest | 类型安全，性能好 |
| 文件存储 | MinIO | release-2024 | S3 兼容，内网部署 |
| 文档转换 | LibreOffice | 7.x (Headless) | Office → PDF |
| PDF 预览 | PDF.js | 2.5.x | Chrome 109 兼容 |
| 表单验证 | Zod | latest | TypeScript 原生 |
| 密码加密 | bcryptjs | latest | 哈希存储 |

### Chrome 109 兼容性配置

```json
{
  "browserslist": [
    "defaults",
    "last 2 versions",
    "chrome 109"
  ]
}
```

- Core-js 提供必要的 Polyfill
- PDF.js 使用 2.5 版本，确保兼容
- 降级方案：在线预览失败时提供下载选项

---

## 七、学习监测机制

### 7.1 行为追踪维度

| 文件类型 | 监测指标 | 记录方式 |
|---------|---------|---------|
| PDF | 打开时间、翻页次数、停留时长、最终页码 | 每翻页/停留60秒上报一次 |
| 视频 | 播放时长、暂停次数、拖拽次数、完成度 | 每播放10秒或操作时上报 |
| Office | 转为 PDF 后同 PDF 处理 | 后端转换后统一处理 |

### 7.2 有效性判断规则

**PDF 有效学习**：
- 打开文件
- 停留时长超过规定时间（默认 5 分钟，可配置）
- 至少翻到最后一页

**视频有效学习**：
- 播放时长超过视频总时长的 80%
- 暂停次数少于 3 次
- 非 1.5 倍速以上播放

**任务完成条件**：
- 所有文件有效学习
- 测试题及格

### 7.3 作弊防护

| 检测项 | 防护措施 |
|--------|---------|
| 页面失焦 | 检测切换标签，暂停计时 |
| 视频 | 检测是否静音、1.5 倍速以上播放 |
| 服务器验证 | 验证上报时间间隔合理性 |
| 异常操作 | 同一 IP/设备频繁操作标记可疑 |

---

## 八、核心业务流程

### 8.1 任务发布流程

```
管理员创建任务
    ↓
填写标题、描述、截止时间
    ↓
上传文件（PDF/Office/视频）
    ↓
系统保存到 MinIO
    ↓
Office 文档 → LibreOffice 转换为 PDF
    ↓
选择必学人员 → 创建任务分配记录
    ↓
创建测试题 → 设置及格分数
    ↓
发布任务 → 通知被分配用户
```

### 8.2 用户学习流程

```
登录
    ↓
首页显示待学习任务列表（按截止时间排序）
    ↓
点击任务 → 进入详情，查看所有文件
    ↓
打开文件 → 开始学习，系统记录行为
    ↓
依次完成所有文件的有效学习
    ↓
进入答题环节 → 提交答案
    ↓
系统判分 → 更新任务完成状态
```

### 8.3 管理员监控流程

```
查看任务总览
    ├── 参与人数
    ├── 完成人数
    └── 平均分数
    ↓
深入查看某任务
    ├── 每人学习进度
    └── 答题情况
    ↓
查看个人详情
    ├── 具体学习日志
    └── 操作轨迹
    ↓
导出报表（Excel）
```

---

## 九、技术要点

### 9.1 Office 转 PDF

使用 LibreOffice Headless 模式转换：

```bash
soffice --headless --convert-to pdf input.docx --outdir output/
```

### 9.2 PDF.js 兼容性

- 使用 2.5.x 版本，确保 Chrome 109 兼容
- 如渲染失败，提供下载备用方案

### 9.3 文件存储

- 原始文件：`/original/{task_id}/{file_id}`
- 转换后文件：`/converted/{task_id}/{file_id}.pdf`
- 视频文件：`/videos/{task_id}/{file_id}`

---

## 十、后续实施计划

1. 搭建 Next.js + PostgreSQL + MinIO 基础环境
2. 实现用户认证和角色管理
3. 实现任务和文件管理功能
4. 集成 LibreOffice 文档转换
5. 实现 PDF.js 在线预览
6. 实现视频播放和进度追踪
7. 实现测试题功能
8. 实现学习行为记录和分析
9. 实现管理员数据看板
10. 兼容性测试（Chrome 109）
11. 性能优化和部署

---

**文档状态**: ✅ 已验证
