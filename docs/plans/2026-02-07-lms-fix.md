# 学习管理系统修复实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标:** 修复所有阻塞性问题，使核心业务流程（管理员创建任务 → 学员学习 → 完成测验）完全可用，测试覆盖率达到90%+

**架构概述:**
- 采用 TDD 方式：先写测试，再实现功能
- 修复优先级：阻塞性问题(P0) > 严重问题(P1) > 优化问题(P2)
- 每个任务包含：问题描述 → 测试用例 → 最小实现 → 验证

**技术栈:** Next.js 14, Drizzle ORM, PostgreSQL, MinIO, Vitest

---

## 问题清单

### P0 - 阻塞性问题（必须修复）

| # | 问题 | 根因 | 影响 |
|---|------|------|------|
| P0-1 | MinIO bucket不存在 | docker-compose没创建bucket | 文件上传整个链路不通 |
| P0-2 | Dashboard SQL错误 | GROUP BY 缺少列 | 数据统计页面500错误 |
| P0-3 | 测验创建403 | 缺少管理员角色检查 | 管理员无法创建测验 |
| P0-4 | FileUploader字段不匹配 | 缺少fileType，title vs name | 带文件任务创建失败 |

### P1 - 严重问题（尽快修复）

| # | 问题 | 根因 | 影响 |
|---|------|------|------|
| P1-1 | 上传URL使用内部主机名 | MINIO_ENDPOINT是minio而非localhost | 浏览器无法访问上传文件 |
| P1-2 | Office转PDF未实现 | LibreOffice集成缺失 | Office文档无法在线预览 |

### P2 - 优化问题（后续修复）

| # | 问题 | 影响 |
|---|------|------|
| P2-1 | 学习有效性判断规则未实现 | 无法判断学习是否有效 |
| P2-2 | 作弊检测机制不完整 | 无法防护学习作弊 |
| P2-3 | 任务完成状态未显示 | 学员不知道是否完成 |

---

## 测试策略

### 测试覆盖目标

| 类型 | 当前覆盖 | 目标覆盖 | 缺口 |
|------|---------|---------|------|
| Statements | ~60% | 90% | +30% |
| Branches | ~50% | 90% | +40% |
| Functions | ~58% | 90% | +32% |
| Lines | ~61% | 90% | +29% |

### E2E 测试清单

| # | 测试场景 | 优先级 | 对应修复 |
|---|---------|--------|---------|
| E2E-1 | 管理员登录 → 创建任务 → 分配用户 | P0 | P0-3, P0-4 |
| E2E-2 | 管理员上传PDF文件 | P0 | P0-1, P1-1 |
| E2E-3 | 管理员创建测验题目 | P0 | P0-3 |
| E2E-4 | 学员登录 → 查看分配任务 | P0 | 验证修复 |
| E2E-5 | 学员完成PDF学习 | P1 | P2-1 |
| E2E-6 | 学员完成测验 | P0 | 验证完整流程 |

---

## 实施任务

### 阶段 1: P0 阻塞性问题修复

#### Task 1: 创建 MinIO Bucket 初始化脚本

**文件:**
- Create: `scripts/init-minio.sh`
- Modify: `docker-compose.yml`

**Step 1: 编写测试**

```bash
# Test: Check if bucket exists after init
test_bucket_exists() {
  docker exec learning-system-minio mc ls local/learning-files >/dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "PASS: Bucket learning-files exists"
    return 0
  else
    echo "FAIL: Bucket learning-files does not exist"
    return 1
  fi
}
test_bucket_exists
```

**Step 2: 运行测试验证失败**

```bash
./scripts/init-minio.sh
test_bucket_exists
# 预期: FAIL (如果bucket不存在)
```

**Step 3: 实现最小代码**

```bash
#!/bin/bash
# scripts/init-minio.sh

set -e

echo "Initializing MinIO bucket..."

# Set mc alias
docker exec learning-system-minio mc alias set local http://localhost:9000 minioadmin minioadmin 2>/dev/null || true

# Create bucket if not exists
if ! docker exec learning-system-minio mc ls local/learning-files >/dev/null 2>&1; then
  docker exec learning-system-minio mc mb local/learning-files
  echo "Bucket learning-files created"
else
  echo "Bucket learning-files already exists"
fi

# Set public read access
docker exec learning-system-minio mc anonymous set public local/learning-files 2>/dev/null || true

echo "MinIO initialization complete"
```

**Step 4: 验证测试通过**

```bash
chmod +x scripts/init-minio.sh
./scripts/init-minio.sh
test_bucket_exists
# 预期: PASS
```

**Step 5: 提交**

```bash
git add scripts/init-minio.sh docker-compose.yml
git commit -m "fix: add MinIO bucket initialization script"
```

---

#### Task 2: 修复 Dashboard SQL GROUP BY 错误

**文件:**
- Modify: `src/app/api/admin/dashboard/route.ts:145-157`

**Step 1: 编写失败的测试**

```typescript
// src/app/api/admin/dashboard/__tests__/user-progress.test.ts

import { describe, it, expect, vi, beforeEach } from 'vitest'
import { GET } from '../route'
import { db } from '@/db'

// Mock db
vi.mock('@/db', () => ({
  db: {
    select: vi.fn().mockReturnValue({
      from: vi.fn().mockReturnValue({
        innerJoin: vi.fn().mockReturnValue({
          groupBy: vi.fn().mockReturnValue({
            orderBy: vi.fn().mockReturnValue({
              limit: vi.fn().mockResolvedValue([
                { userId: 'user1', username: 'test', totalDuration: 100, activityCount: 5 }
              ])
            })
          })
        })
      })
    })
  }
}))

describe('Dashboard User Progress', () => {
  it('should not throw GROUP BY error when querying user progress', async () => {
    const request = new Request('http://localhost/api/admin/dashboard')
    // This should not throw SQL syntax error
    await expect(GET(request)).resolves.not.toThrow()
  })
})
```

**Step 2: 运行测试验证失败**

```bash
cd /home/jack/.worktrees/implementation/.worktrees/feature-lms-fix
npm test -- src/app/api/admin/dashboard/__tests__/user-progress.test.ts
# 预期: FAIL (GROUP BY error)
```

**Step 3: 修复 SQL**

```typescript
// src/app/api/admin/dashboard/route.ts:145-157

// BEFORE (broken):
const userProgressStats = await db
  .select({
    userId: learningLogs.userId,
    username: users.username,  // ERROR: not in GROUP BY
    totalDuration: sql<number>`SUM(${learningLogs.duration})`,
    activityCount: count(),
  })
  .from(learningLogs)
  .innerJoin(users, eq(learningLogs.userId, users.id))
  .groupBy(learningLogs.userId)  // Missing users.username
  .orderBy(desc(sql`SUM(${learningLogs.duration})`))
  .limit(5)

// AFTER (fixed):
const userProgressStats = await db
  .select({
    userId: learningLogs.userId,
    username: users.username,
    totalDuration: sql<number>`SUM(${learningLogs.duration})`,
    activityCount: count(),
  })
  .from(learningLogs)
  .innerJoin(users, eq(learningLogs.userId, users.id))
  .groupBy(learningLogs.userId, users.username)  // Added users.username
  .orderBy(desc(sql`SUM(${learningLogs.duration})`))
  .limit(5)
```

**Step 4: 验证测试通过**

```bash
npm test -- src/app/api/admin/dashboard/__tests__/user-progress.test.ts
# 预期: PASS
```

**Step 5: 提交**

```bash
git add src/app/api/admin/dashboard/route.ts
git commit -m "fix: add users.username to GROUP BY clause"
```

---

#### Task 3: 修复测验创建权限检查

**文件:**
- Modify: `src/app/api/quiz/questions/route.ts:127-144`

**Step 1: 编写失败的测试**

```typescript
// src/app/api/quiz/questions/__tests__/admin-create.test.ts

import { describe, it, expect, vi, beforeEach } from 'vitest'
import { POST } from '../route'
import { db } from '@/db'

// Mock db
vi.mock('@/db', () => ({
  db: {
    select: vi.fn().mockReturnValue({
      from: vi.fn().mockReturnValue({
        where: vi.fn().mockReturnValue({
          limit: vi.fn().mockResolvedValue([{ role: 'admin' }])
        })
      })
    }),
    insert: vi.fn().mockReturnValue({
      values: vi.fn().mockReturnValue({
        returning: vi.fn().mockResolvedValue([{ id: 'q1', taskId: 't1' }])
      })
    })
  }
}))

describe('Quiz Question Creation', () => {
  it('should allow admin to create questions for any task', async () => {
    const request = new Request('http://localhost/api/quiz/questions', {
      method: 'POST',
      body: JSON.stringify({
        taskId: 'task-123',
        question: 'Test question?',
        options: ['A', 'B', 'C', 'D'],
        correctAnswer: 0
      })
    })

    const response = await POST(request)
    expect(response.status).not.toBe(403)
  })
})
```

**Step 2: 运行测试验证失败**

```bash
npm test -- src/app/api/quiz/questions/__tests__/admin-create.test.ts
# 预期: FAIL (403 error)
```

**Step 3: 修复权限检查**

```typescript
// src/app/api/quiz/questions/route.ts:81-145

export async function POST(request: NextRequest) {
  const auth = await validateRequest(request)
  if (!auth) {
    return NextResponse.json({ success: false, error: '未授权' }, { status: 401 })
  }

  try {
    const body = await request.json()
    const { taskId, question, options, correctAnswer } = body

    // Validate required fields
    if (!taskId || !question || !options || correctAnswer === undefined) {
      return NextResponse.json(
        { success: false, error: '缺少必要参数' },
        { status: 400 }
      )
    }

    // Check if task exists
    const [task] = await db
      .select()
      .from(tasks)
      .where(eq(tasks.id, taskId))
      .limit(1)

    if (!task) {
      return NextResponse.json(
        { success: false, error: '任务不存在' },
        { status: 404 }
      )
    }

    // FIX: Check if user is admin OR is assigned to task
    const [currentUser] = await db
      .select()
      .from(users)
      .where(eq(users.id, auth.userId))
      .limit(1)

    const isAdmin = currentUser?.role === 'admin'

    if (!isAdmin) {
      // Check if user is assigned to task
      const [assignment] = await db
        .select()
        .from(taskAssignments)
        .where(
          and(
            eq(taskAssignments.taskId, taskId),
            eq(taskAssignments.userId, auth.userId)
          )
        )
        .limit(1)

      if (!assignment) {
        return NextResponse.json(
          { success: false, error: '无权访问此任务' },
          { status: 403 }
        )
      }
    }

    // Create the question (admin can create for any task)
    const [newQuestion] = await db
      .insert(quizQuestions)
      .values({
        taskId,
        question,
        options,
        correctAnswer,
      })
      .returning({
        id: quizQuestions.id,
        taskId: quizQuestions.taskId,
        question: quizQuestions.question,
        options: quizQuestions.options,
        correctAnswer: quizQuestions.correctAnswer,
      })

    return NextResponse.json({
      success: true,
      data: newQuestion,
    })
  } catch (error) {
    console.error('创建题目失败:', error)
    return NextResponse.json(
      { success: false, error: '创建题目失败' },
      { status: 500 }
    )
  }
}
```

**Step 4: 验证测试通过**

```bash
npm test -- src/app/api/quiz/questions/__tests__/admin-create.test.ts
# 预期: PASS
```

**Step 5: 提交**

```bash
git add src/app/api/quiz/questions/route.ts
git commit -m "fix: allow admin to create quiz questions for any task"
```

---

#### Task 4: 修复 FileUploader 字段不匹配

**文件:**
- Modify: `src/components/FileUploader.tsx`

**Step 1: 编写失败的测试**

```typescript
// src/components/__tests__/FileUploader-field-mapping.test.tsx

import { describe, it, expect, vi, beforeEach } from 'vitest'
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { FileUploader } from '../FileUploader'

describe('FileUploader Field Mapping', () => {
  it('should return correct field names for task creation API', async () => {
    let uploadedData: any = null

    const handleFilesChange = (files: any[]) => {
      uploadedData = files
    }

    // Mock fetch
    global.fetch = vi.fn().mockResolvedValueOnce({
      ok: true,
      json: () => Promise.resolve({
        success: true,
        url: 'http://localhost:9000/learning-files/tasks/test.pdf',
        path: 'tasks/test.pdf',
        size: 1024
      })
    })

    render(<FileUploader onFilesChange={handleFilesChange} prefix="tasks" />)

    // Simulate file selection and upload
    // ... (setup file mock)

    await waitFor(() => {
      expect(uploadedData).toHaveLength(1)
      // Verify field names match API schema
      expect(uploadedData[0]).toHaveProperty('title')    // NOT 'name'
      expect(uploadedData[0]).toHaveProperty('fileType') // REQUIRED
      expect(uploadedData[0]).toHaveProperty('fileUrl')   // NOT 'url'
      expect(uploadedData[0]).toHaveProperty('fileSize')  // NOT 'size'
    })
  })
})
```

**Step 2: 运行测试验证失败**

```bash
npm test -- src/components/__tests__/FileUploader-field-mapping.test.tsx
# 预期: FAIL (missing fileType, wrong field names)
```

**Step 3: 修复 FileUploader**

```typescript
// src/components/FileUploader.tsx:79-86

// BEFORE:
uploadedFiles.push({
  name: file.name,
  url: data.url,
  path: data.path,
  size: data.size,
})

// AFTER:
uploadedFiles.push({
  title: file.name,                                    // Changed from 'name'
  fileUrl: data.url,                                  // Changed from 'url'
  fileType: detectFileType(file.name),                // ADDED
  fileSize: data.size,                                // Changed from 'size'
})

// Add helper function
function detectFileType(filename: string): string {
  const ext = filename.split('.').pop()?.toLowerCase()
  switch (ext) {
    case 'pdf': return 'pdf'
    case 'docx': return 'docx'
    case 'xlsx': return 'xlsx'
    case 'pptx': return 'pptx'
    case 'mp4':
    case 'mov':
    case 'avi': return 'video'
    default: return 'other'
  }
}
```

**Step 4: 验证测试通过**

```bash
npm test -- src/components/__tests__/FileUploader-field-mapping.test.tsx
# 预期: PASS
```

**Step 5: 提交**

```bash
git add src/components/FileUploader.tsx
git commit -m "fix: correct field names for task creation API"
```

---

### 阶段 2: P1 严重问题修复

#### Task 5: 修复上传文件 URL 主机名

**文件:**
- Create: `src/lib/storage/url-resolver.ts`
- Modify: `src/app/api/upload/route.ts`

**Step 1: 编写失败的测试**

```typescript
// src/lib/storage/__tests__/url-resolver.test.ts

import { describe, it, expect } from 'vitest'
import { getPublicFileUrl } from '../url-resolver'

describe('File URL Resolution', () => {
  it('should return accessible URL for browser', () => {
    const internalUrl = 'http://minio:9000/learning-files/tasks/test.pdf'
    const publicUrl = getPublicFileUrl(internalUrl)

    expect(publicUrl).toBe('http://localhost:9000/learning-files/tasks/test.pdf')
    expect(publicUrl).not.toContain('minio:9000')
  })

  it('should handle localhost URLs unchanged', () => {
    const url = 'http://localhost:9000/learning-files/tasks/test.pdf'
    const result = getPublicFileUrl(url)
    expect(result).toBe(url)
  })
})
```

**Step 2: 运行测试验证失败**

```bash
npm test -- src/lib/storage/__tests__/url-resolver.test.ts
# 预期: FAIL (function not defined)
```

**Step 3: 实现 URL 解析器**

```typescript
// src/lib/storage/url-resolver.ts

export function getPublicFileUrl(internalUrl: string): string {
  // Replace internal MinIO hostname with localhost for browser access
  return internalUrl.replace('minio:9000', 'localhost:9000')
}

export function getInternalFileUrl(publicUrl: string): string {
  // Reverse: replace localhost with minio for server-side operations
  return publicUrl.replace('localhost:9000', 'minio:9000')
}
```

**Step 4: 验证测试通过**

```bash
npm test -- src/lib/storage/__tests__/url-resolver.test.ts
# 预期: PASS
```

**Step 5: 修复上传 API**

```typescript
// src/app/api/upload/route.ts:44

// BEFORE:
const url = `${env().MINIO_USE_SSL ? 'https' : 'http'}://${env().MINIO_ENDPOINT}:${env().MINIO_PORT}/${env().MINIO_BUCKET}/${path}`

// AFTER:
const internalUrl = `${env().MINIO_USE_SSL ? 'https' : 'http'}://${env().MINIO_ENDPOINT}:${env().MINIO_PORT}/${env().MINIO_BUCKET}/${path}`
const url = getPublicFileUrl(internalUrl)
```

**Step 6: 验证完整测试**

```bash
npm test -- src/lib/storage/__tests__/
# 预期: PASS
```

**Step 7: 提交**

```bash
git add src/lib/storage/url-resolver.ts src/app/api/upload/route.ts
git commit -m "fix: resolve MinIO URLs for browser access"
```

---

### 阶段 3: 集成测试验证

#### Task 6: 端到端流程测试

**文件:**
- Create: `e2e/admin-task-creation.spec.ts`
- Create: `e2e/learner-flow.spec.ts`

**Step 1: 安装 Playwright**

```bash
npm install -D @playwright/test
npx playwright install chromium
```

**Step 2: 编写 E2E 测试**

```typescript
// e2e/admin-task-creation.spec.ts

import { test, expect } from '@playwright/test'

test.describe('Admin Task Creation Flow', () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto('http://localhost:3000/login')
    await page.fill('input[name="username"]', 'admin')
    await page.fill('input[name="password"]', 'Admin@123')
    await page.click('button:has-text("登录")')
    await page.waitForURL('**/admin')
  })

  test('should create task with file upload', async ({ page }) => {
    // Navigate to task creation
    await page.goto('http://localhost:3000/admin/tasks/create')

    // Fill task info
    await page.fill('input#title', 'E2E Test Task')
    await page.fill('textarea#description', 'Test description')

    // Upload file
    const fileChooserPromise = page.waitForEvent('filechooser')
    await page.click('text=拖拽文件到此处')
    const fileChooser = await fileChooserPromise
    await fileChooser.setFiles(['e2e/fixtures/test.pdf'])
    await page.waitForSelector('text=test.pdf')

    // Select user
    await page.check('label:has-text("admin")')

    // Submit
    await page.click('button:has-text("创建任务")')

    // Verify redirect to task list
    await page.waitForURL('**/admin/tasks')
    await expect(page.locator('h3:has-text("E2E Test Task")')).toBeVisible()
  })

  test('should create quiz question', async ({ page }) => {
    // Navigate to task detail
    await page.goto('http://localhost:3000/admin/tasks/21a1f551-2a1f-44a8-bb28-9341b6447430')

    // Go to quiz tab
    await page.click('button:has-text("测验设置")')

    // Add question
    await page.click('button:has-text("添加题目")')

    await page.fill('textarea >> nth=0', 'What is the capital of France?')
    await page.fill('textbox >> nth=1', 'London')
    await page.fill('textbox >> nth=2', 'Paris')
    await page.fill('textbox >> nth=3', 'Berlin')
    await page.fill('textbox >> nth=4', 'Madrid')

    // Select correct answer (option 2 - Paris)
    await page.click('label:has-text("选项 2")')

    // Submit
    await page.click('button:has-text("添加题目")')

    // Verify question created
    await expect(page.locator('text=What is the capital of France?')).toBeVisible()
  })
})
```

**Step 3: 运行 E2E 测试**

```bash
npx playwright test e2e/admin-task-creation.spec.ts --reporter=line
```

**Step 4: 提交**

```bash
git add e2e/
git commit -m "test: add E2E tests for admin task creation flow"
```

---

## 执行方式选择

**计划已完成并保存到** `docs/plans/2026-02-07-lms-fix.md`

**两种执行方式：**

1. **子代理驱动（当前会话）** - 我逐个分发任务，任务间进行代码审查
2. **并行会话（单独会话）** - 在新会话中批量执行任务，中间有检查点

请选择你偏好的执行方式，我会相应继续。
