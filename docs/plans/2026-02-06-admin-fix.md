# Admin 页面功能修复实施计划

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**目标**：修复管理员页面的布局和功能缺失问题，使所有页面拥有一致的用户体验和完整功能

**架构**：
1. 为所有管理页面统一添加 AdminLayout 布局
2. 创建缺失的创建任务页面
3. 创建缺失的退出登录 API

**技术栈**：Next.js 14 App Router, React, Drizzle ORM, PostgreSQL

---

## 修复优先级

| 优先级 | 问题 | 影响 |
|--------|------|------|
| P0 | 缺少创建任务页面 `/admin/tasks/create` | 无法创建任务 |
| P0 | 退出登录 API 不存在 | 所有用户无法退出 |
| P1 | 任务管理页面缺少 AdminLayout | 布局不一致 |
| P1 | 用户管理页面缺少 AdminLayout | 布局不一致 |

---

## 任务 1：创建退出登录 API

**文件**：
- 创建：`src/app/api/auth/logout/route.ts`
- 修改：`src/components/layout/AdminHeader.tsx`（添加退出功能）

**步骤**：

### Step 1: 创建退出登录 API 测试

```typescript
// src/app/api/auth/__tests__/logout.test.ts
import { POST } from '../logout/route'
import { NextRequest, NextResponse } from 'next/server'
import * as jose from 'jose'

// Mock request and cookies
const mockRequest = {
  cookies: {
    get: (name: string) => {
      if (name === 'session-token') {
        return { value: 'valid-token' }
      }
      return undefined
    }
  }
} as unknown as NextRequest

describe('POST /api/auth/logout', () => {
  it('应该清除 session cookie 并返回成功', async () => {
    const response = await POST(mockRequest)
    expect(response.status).toBe(200)
    const data = await response.json()
    expect(data.success).toBe(true)
  })

  it('应该在 cookie 中设置已过期的 session-token', async () => {
    const response = await POST(mockRequest)
    const setCookie = response.headers.get('set-cookie')
    expect(setCookie).toContain('session-token=')
    expect(setCookie).toContain('Max-Age=0')
  })
})
```

### Step 2: 创建退出登录 API

```typescript
// src/app/api/auth/logout/route.ts
import { NextRequest, NextResponse } from 'next/server'

export async function POST(request: NextRequest) {
  try {
    // 创建已过期的 cookie 来清除 session
    const response = NextResponse.json({ success: true, message: '退出成功' })

    response.cookies.set('session-token', '', {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 0, // 立即过期
      path: '/',
    })

    return response
  } catch {
    return NextResponse.json(
      { success: false, error: '退出失败' },
      { status: 500 }
    )
  }
}
```

### Step 3: 运行测试验证

```bash
npm test src/app/api/auth/__tests__/logout.test.ts
```

---

## 任务 2：创建创建任务页面

**文件**：
- 创建：`src/app/admin/tasks/create/page.tsx`
- 创建：`src/app/admin/tasks/create/__tests__/page.test.tsx`

**步骤**：

### Step 1: 创建创建任务页面测试

```typescript
// src/app/admin/tasks/create/__tests__/page.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import CreateTaskPage from '../page'
import '@testing-library/jest-dom'

// Mock fetch
global.fetch = vi.fn()

describe('CreateTaskPage', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  it('应该显示创建任务表单', () => {
    render(<CreateTaskPage />)
    expect(screen.getByText('创建任务')).toBeInTheDocument()
    expect(screen.getByLabelText('标题')).toBeInTheDocument()
    expect(screen.getByLabelText('描述')).toBeInTheDocument()
  })

  it('应该能够提交任务表单', async () => {
    // Mock task creation
    ;(fetch as any).mockResolvedValueOnce({
      ok: true,
      json: async () => ({
        success: true,
        data: { id: 'new-task-id', title: 'Test Task' }
      })
    })

    render(<CreateTaskPage />)

    // Fill form
    fireEvent.change(screen.getByLabelText('标题'), {
      target: { value: 'Test Task' }
    })
    fireEvent.change(screen.getByLabelText('描述'), {
      target: { value: 'Test Description' }
    })

    // Submit
    fireEvent.click(screen.getByText('创建'))

    await waitFor(() => {
      expect(fetch).toHaveBeenCalledWith(
        '/api/tasks',
        expect.objectContaining({ method: 'POST' })
      )
    })
  })
})
```

### Step 2: 创建创建任务页面

```typescript
// src/app/admin/tasks/create/page.tsx
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'
import { ArrowLeft, Save, Upload } from 'lucide-react'
import Link from 'next/link'

export default function CreateTaskPage() {
  const [loading, setLoading] = useState(false)
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    deadline: '',
  })
  const router = useRouter()

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)

    try {
      const res = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData),
      })

      if (res.ok) {
        const data = await res.json()
        // 跳转到任务编辑页面继续添加文件、分配用户等
        router.push(`/admin/tasks/${data.data.id}`)
      }
    } catch {
      console.error('创建失败')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center gap-4">
        <Link href="/admin/tasks">
          <Button variant="ghost" size="sm">
            <ArrowLeft className="w-4 h-4 mr-2" />返回
          </Button>
        </Link>
        <h1 className="text-2xl font-bold">创建任务</h1>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>基本信息</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div>
              <label className="text-sm font-medium">标题</label>
              <Input
                value={formData.title}
                onChange={e => setFormData({ ...formData, title: e.target.value })}
                className="mt-1"
                placeholder="请输入任务标题"
                required
              />
            </div>
            <div>
              <label className="text-sm font-medium">描述</label>
              <Textarea
                value={formData.description}
                onChange={e => setFormData({ ...formData, description: e.target.value })}
                className="mt-1"
                placeholder="请输入任务描述"
              />
            </div>
            <div>
              <label className="text-sm font-medium">截止时间</label>
              <Input
                type="datetime-local"
                value={formData.deadline}
                onChange={e => setFormData({ ...formData, deadline: e.target.value })}
                className="mt-1"
              />
            </div>
            <Button type="submit" disabled={loading}>
              <Save className="w-4 h-4 mr-2" />
              {loading ? '创建中...' : '创建任务'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

### Step 3: 确保 POST /api/tasks API 支持创建任务

```typescript
// src/app/api/tasks/route.ts 添加 POST 方法
export async function POST(request: NextRequest) {
  // 验证管理员权限
  const auth = await validateRequest(request)
  if (!auth) {
    return NextResponse.json({ success: false, error: '未授权' }, { status: 401 })
  }

  const [currentUser] = await db
    .select()
    .from(users)
    .where(eq(users.id, auth.userId))
    .limit(1)

  if (!currentUser || currentUser.role !== 'admin') {
    return NextResponse.json(
      { success: false, error: '需要管理员权限' },
      { status: 403 }
    )
  }

  try {
    const body = await request.json()
    const { title, description, deadline } = body

    if (!title) {
      return NextResponse.json(
        { success: false, error: '标题是必填项' },
        { status: 400 }
      )
    }

    const [task] = await db
      .insert(tasks)
      .values({
        title,
        description: description || null,
        deadline: deadline ? new Date(deadline) : null,
        createdBy: auth.userId,
      })
      .returning()

    return NextResponse.json({
      success: true,
      data: task,
    })
  } catch {
    return NextResponse.json(
      { success: false, error: '创建任务失败' },
      { status: 500 }
    )
  }
}
```

---

## 任务 3：为任务管理页面添加 AdminLayout

**文件**：
- 修改：`src/app/admin/tasks/page.tsx`
- 修改：`src/app/admin/tasks/TaskList.tsx`

### Step 1: 添加 AdminLayout 到任务列表页面

```typescript
// src/app/admin/tasks/page.tsx
import { AdminLayout } from '@/components/layout/AdminLayout'
import TaskList from './TaskList'

export default function AdminTasksPage() {
  return (
    <AdminLayout>
      <TaskList />
    </AdminLayout>
  )
}
```

### Step 2: 移除 TaskList 中的重复标题（因为 AdminLayout 会渲染内容区域）

```typescript
// src/app/admin/tasks/TaskList.tsx
// 修改返回内容，移除最外层的 div 包装和标题
export default function TaskList() {
  // ... 保持原有的状态和逻辑

  return (
    <div className="space-y-4">
      {/* 保留标题和创建按钮 */}
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">任务管理</h1>
        {/* ... */}
      </div>
      {/* 保留任务列表 */}
    </div>
  )
}
```

---

## 任务 4：为用户管理页面添加 AdminLayout

**文件**：
- 修改：`src/app/admin/users/page.tsx`

### Step 1: 添加 AdminLayout 到用户列表页面

```typescript
// src/app/admin/users/page.tsx
import { AdminLayout } from '@/components/layout/AdminLayout'
import UserList from './UserList'

export default function AdminUsersPage() {
  return (
    <AdminLayout>
      <UserList />
    </AdminLayout>
  )
}
```

---

## 任务 5：为 AdminHeader 添加退出功能

**文件**：
- 修改：`src/components/layout/AdminHeader.tsx`

```typescript
// src/components/layout/AdminHeader.tsx
'use client'

import { useRouter } from 'next/navigation'
import { LogOut, User } from 'lucide-react'

export function AdminHeader() {
  const router = useRouter()

  const handleLogout = async () => {
    try {
      await fetch('/api/auth/logout', { method: 'POST' })
      router.push('/login')
      router.refresh()
    } catch {
      console.error('退出失败')
    }
  }

  return (
    <header className="fixed top-0 right-0 z-40 h-16 w-[calc(100%-16rem)] bg-white border-b border-gray-200">
      <div className="flex h-full items-center justify-between px-6">
        {/* Page Title */}
        <div>
          <h1 className="text-xl font-semibold text-slate-900">管理后台</h1>
        </div>

        {/* User Menu */}
        <div className="flex items-center gap-4">
          <button className="flex items-center gap-2 px-3 py-1.5 rounded-md hover:bg-slate-100 transition-colors">
            <div className="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
              <User className="w-4 h-4 text-primary-600" />
            </div>
            <span className="text-sm font-medium text-slate-700">admin</span>
          </button>
          <button
            onClick={handleLogout}
            className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-md transition-colors"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </div>
    </header>
  )
}
```

---

## 验证步骤

所有修复完成后，运行以下命令验证：

```bash
# 1. 运行所有测试
npm test

# 2. 检查测试覆盖
npm test -- --coverage

# 3. 启动开发服务器验证
npm run dev

# 4. 在浏览器中验证：
# - 访问 /admin/tasks - 应该显示带布局的任务列表
# - 点击"创建任务" - 应该跳转到创建页面
# - 创建任务后跳转到编辑页面
# - 访问 /admin/users - 应该显示带布局的用户列表
# - 点击退出按钮 - 应该成功退出并跳转到登录页
```

---

## 提交历史

1. `feat: 添加退出登录 API`
2. `feat: 创建任务创建页面`
3. `feat: 为任务管理页面添加 AdminLayout`
4. `feat: 为用户管理页面添加 AdminLayout`
5. `feat: 为 AdminHeader 添加退出功能`
