# 学习管理系统 - 学习追踪模块需求规格

## 文档信息

| 项目 | 内容 |
|-----|------|
| 文档名称 | 学习追踪模块 - 详细规格 |
| 版本 | v1.0 |
| 状态 | 已确认 |
| 所属模块 | 模块三 |

---

## 目录

1. [功能概述](#1-功能概述)
2. [用户界面](#2-用户界面)
3. [API 接口](#3-api-接口)
4. [数据模型](#4-数据模型)
5. [业务规则](#5-业务规则)

---

## 1. 功能概述

### 1.1 模块目标

记录员工学习行为，计算有效学习时长，追踪文件学习进度，并在用户完成所有学习内容后支持提交任务完成确认。

### 1.2 核心功能清单

| 功能 | 优先级 | 描述 |
|-----|-------|------|
| 学习页面 | P0 | 学习任务主页面，显示文件列表和学习进度 |
| PDF 阅读 | P0 | PDF 文件在线阅读，追踪阅读进度 |
| 视频播放 | P0 | 视频在线播放，追踪观看进度 |
| 进度记录 | P0 | 记录每份文件的学习进度和有效时长 |
| 有效时间计算 | P0 | 只计算用户活跃时的学习时间 |
| 文件完成判定 | P0 | 判断 PDF 是否读完、视频是否看完 |
| 提交完成任务 | P0 | 用户确认任务完成 |

### 1.3 优先级说明

| 优先级 | 说明 |
|-------|------|
| P0 | 核心功能，必须实现 |
| P1 | 重要功能，应该实现 |
| P2 | 增强功能，可以后续实现 |

---

## 2. 用户界面

### 2.1 学习任务页面

**页面路径**：`/tasks/[id]/learn`

**页面布局**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  学习任务：新员工入职培训                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  任务信息                                                         │ │
│  │  ───────────────────────────────────────────────────────────  │ │
│  │  描述：帮助新员工快速了解公司文化和工作流程                      │ │
│  │  截止日期：2024-01-31                                            │ │
│  │  状态：[进行中] [已完成]                                         │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  学习进度 (2/3 文件完成)                                        │ │
│  │  [███████████████████████..........] 67%                      │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  学习文件列表                                                     │ │
│  ├───────────────────────────────────────────────────────────────┤ │
│  │                                                                      │ │
│  │  ┌─────────────────────────────────────────────────────────┐   │ │
│  │  │  1  [PDF]  公司介绍.pdf         5/5页  ⏱ 5分30秒     │   │ │
│  │  │       ✅ 已完成                                           │   │ │
│  │  └─────────────────────────────────────────────────────────┘   │ │
│  │                                                                      │ │
│  │  ┌─────────────────────────────────────────────────────────┐   │ │
│  │  │  2  [视频]  安全规范视频.mp4     8:30/10:00  ⏱ 3分    │   │ │
│  │  │       🔄 进行中                                           │   │ │
│  │  │       [ 继续学习 ]                                       │   │ │
│  │  └─────────────────────────────────────────────────────────┘   │ │
│  │                                                                      │ │
│  │  ┌─────────────────────────────────────────────────────────┐   │ │
│  │  │  3  [PDF]  工作流程.pdf         未开始                  │   │ │
│  │  │       ⭕ 未开始                                           │   │ │
│  │  │       [ 开始学习 ]                                       │   │ │
│  │  └─────────────────────────────────────────────────────────┘   │ │
│  │                                                                      │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  测验信息                                                       │ │
│  │  ───────────────────────────────────────────────────────────  │ │
│  │  状态：未开始                                                   │ │
│  │  题量：5 题                                                    │ │
│  │       [ 开始测验 ]                                              │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                  │ │
│  │              [ 确认任务完成 ]                                    │ │
│  │                                                                  │ │
│  │         （所有文件学习完成后方可提交）                            │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**文件列表项状态说明**：

| 状态 | 图标 | 说明 |
|-----|------|------|
| 未开始 | ⭕ | 用户尚未开始学习该文件 |
| 进行中 | 🔄 | 用户已开始学习，未完成 |
| 已完成 | ✅ | 用户已完成该文件学习 |
| 已过期 | ⚠️ | 超过截止日期 |

---

### 2.2 PDF 阅读页面

**页面路径**：`/tasks/[id]/learn/[fileId]`

**页面布局**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  [返回]  公司介绍.pdf                                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  学习进度                                                        │ │
│  │  第 3/5 页  │  60%  │  ⏱ 5分30秒有效时长                       │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                  │ │
│  │                    PDF 文档预览区域                             │ │
│  │                    (iframe 或 canvas 渲染)                      │ │
│  │                                                                  │ │
│  │                    第 3 页 / 共 5 页                           │ │
│  │                                                                  │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  页面导航                                                        │ │
│  │      [< 上一页]      [第 3 页 / 5 页]      [下一页 >]         │ │
│  │                                                                  │ │
│  │  📊 阅读进度：███████░░░░░  60%                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  学习统计                                                        │ │
│  │  ───────────────────────────────────────────────────────────  │ │
│  │  有效时长：5分30秒  │  本次阅读：3分12秒                       │ │
│  │  首次阅读：2024-01-15 10:30                                   │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 2.3 视频播放页面

**页面路径**：`/tasks/[id]/learn/[fileId]`

**页面布局**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  [返回]  安全规范视频.mp4                                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  学习进度                                                        │ │
│  │  08:30 / 10:00  │  85%  │  ⏱ 3分有效时长                       │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                                                                  │ │
│  │                    视频播放器                                    │ │
│  │                    ──────────────────                           │ │
│  │                    [███████████████████████████░░░░░]         │ │
│  │                    00:00 ────────────────────── 10:00         │ │
│  │                                                                  │ │
│  │                    [▶] [⏸] [🔊 1x]                            │ │
│  │                                                                  │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  播放控制                                                        │ │
│  │      [< 重新播放]      [▶ 继续播放]      [下一页 >]            │ │
│  │                                                                  │ │
│  │  📊 观看进度：███████████████░░░░░░░░  85%                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │  学习统计                                                        │ │
│  │  ───────────────────────────────────────────────────────────  │ │
│  │  有效时长：3分00秒  │  观看次数：2 次                          │ │
│  │  最后观看：2024-01-15 11:30                                   │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 2.4 确认完成任务弹窗

**交互流程**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│                         ┌─────────────────────────────────┐         │
│                         │                                 │         │
│                         │     ⚠️ 确认完成任务？           │         │
│                         │                                 │         │
│                         │  ───────────────────────────  │         │
│                         │                                 │         │
│                         │  请确认以下内容已完成：          │         │
│                         │                                 │         │
│                         │  ✅ 公司介绍.pdf  (5页/5页)    │         │
│                         │  ✅ 安全规范视频 (10:00/10:00) │         │
│                         │  ✅ 工作流程.pdf  (10页/10页)  │         │
│                         │                                 │         │
│                         │  ───────────────────────────  │         │
│                         │                                 │         │
│                         │  ☐ 我确认已完成所有学习内容     │         │
│                         │                                 │         │
│                         │    [ 取消 ]       [ 确认完成 ] │         │
│                         │                                 │         │
│                         └─────────────────────────────────┘         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. API 接口

### 3.1 获取学习数据接口

#### 3.1.1 获取任务学习详情

**接口**：`GET /api/tasks/[id]/learn`

**响应示例**：

```json
{
  "success": true,
  "data": {
    "task": {
      "id": "task-uuid",
      "title": "新员工入职培训",
      "description": "帮助新员工快速了解公司",
      "deadline": "2024-01-31T23:59:59Z"
    },
    "files": [
      {
        "id": "file-uuid-1",
        "title": "公司介绍.pdf",
        "file_type": "pdf",
        "file_size": 1258291,
        "duration": null,
        "total_pages": 5,
        "progress": {
          "current_page": 5,
          "progress_percent": 100,
          "effective_time": 330,
          "is_completed": true,
          "completed_at": "2024-01-15T10:30:00Z"
        }
      },
      {
        "id": "file-uuid-2",
        "title": "安全规范视频.mp4",
        "file_type": "video",
        "file_size": 47815040,
        "duration": 600,
        "progress": {
          "current_time": 510,
          "progress_percent": 85,
          "effective_time": 180,
          "is_completed": false,
          "completed_at": null
        }
      }
    ],
    "assignment": {
      "is_completed": false,
      "submitted_at": null
    },
    "quiz": {
      "enabled": true,
      "completed": false,
      "passed": null
    }
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

---

### 3.2 学习进度接口

#### 3.2.1 记录 PDF 学习日志

**接口**：`POST /api/learning/log/pdf`

**请求体**：

```json
{
  "fileId": "file-uuid",
  "taskId": "task-uuid",
  "pageNum": 3,
  "scrollPosition": 0.6,
  "actionType": "page_change",
  "sessionDuration": 120
}
```

**响应**：

```json
{
  "success": true,
  "data": {
    "currentPage": 3,
    "totalPages": 5,
    "progressPercent": 60,
    "effectiveTime": 1800,
    "isCompleted": false
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.2.2 记录视频播放日志

**接口**：`POST /api/learning/log/video`

**请求体**：

```json
{
  "fileId": "file-uuid",
  "taskId": "task-uuid",
  "currentTime": 150,
  "duration": 600,
  "action": "time_update",
  "playbackRate": 1.0,
  "isMuted": false,
  "sessionDuration": 60
}
```

**响应**：

```json
{
  "success": true,
  "data": {
    "currentTime": 150,
    "duration": 600,
    "progressPercent": 25,
    "effectiveTime": 900,
    "isCompleted": false
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

#### 3.2.3 更新有效时长

**接口**：`POST /api/learning/time`

**请求体**：

```json
{
  "fileId": "file-uuid",
  "sessionDuration": 60,
  "isActive": true
}
```

---

### 3.3 学习进度查询接口

#### 3.3.1 获取文件学习进度

**接口**：`GET /api/learning/progress/[fileId]`

**响应**：

```json
{
  "success": true,
  "data": {
    "fileId": "file-uuid",
    "currentPage": 3,
    "currentTime": 0,
    "progressPercent": 60,
    "effectiveTime": 1800,
    "isCompleted": false,
    "startedAt": "2024-01-15T10:00:00Z",
    "lastAccessed": "2024-01-20T12:00:00Z"
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

---

### 3.4 完成任务确认接口

#### 3.4.1 提交任务完成

**接口**：`POST /api/tasks/[id]/complete`

**请求体**：

```json
{
  "confirmed": true
}
```

**响应**：

```json
{
  "success": true,
  "data": {
    "isCompleted": true,
    "submittedAt": "2024-01-20T12:00:00Z"
  },
  "meta": {
    "message": "任务已完成"
  },
  "timestamp": "2024-01-20T12:00:00Z"
}
```

---

### 3.5 错误码说明

| 错误码 | 说明 |
|-------|------|
| 400 | 参数错误 |
| 401 | 未登录或登录已过期 |
| 403 | 无权限操作 |
| 404 | 任务/文件不存在 |
| 409 | 验证失败（如文件未完成） |
| 500 | 服务器内部错误 |

---

## 4. 数据模型

### 4.1 file_progress 表

```sql
CREATE TABLE file_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  file_id UUID NOT NULL REFERENCES task_files(id) ON DELETE CASCADE,
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,

  -- PDF 进度
  current_page INT DEFAULT 0,
  total_pages INT DEFAULT 0,
  scroll_position DECIMAL(5,2) DEFAULT 0,

  -- 视频进度
  current_time INT DEFAULT 0,
  duration INT DEFAULT 0,

  -- 通用进度
  progress DECIMAL(5,2) NOT NULL DEFAULT 0,
  effective_time INT NOT NULL DEFAULT 0,

  -- 时间戳
  started_at TIMESTAMP NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMP,
  last_accessed TIMESTAMP NOT NULL DEFAULT NOW(),

  UNIQUE(user_id, file_id)
);

CREATE INDEX idx_file_progress_user_id ON file_progress(user_id);
CREATE INDEX idx_file_progress_file_id ON file_progress(file_id);
CREATE INDEX idx_file_progress_task_id ON file_progress(task_id);
```

### 4.2 learning_logs 表

```sql
CREATE TABLE learning_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  file_id UUID NOT NULL REFERENCES task_files(id) ON DELETE CASCADE,
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  log_type VARCHAR(20) NOT NULL,
  page_num INT,
  current_time INT,
  action VARCHAR(20),
  session_duration INT NOT NULL,
  is_active_session BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_learning_logs_user_id ON learning_logs(user_id);
CREATE INDEX idx_learning_logs_file_id ON learning_logs(file_id);
CREATE INDEX idx_learning_logs_task_id ON learning_logs(task_id);
```

---

## 5. 业务规则

### 5.1 有效学习时间计算规则

| 场景 | 是否计入有效时间 |
|-----|----------------|
| 用户在标签页内正常学习 | ✅ 计入 |
| 切换到其他标签页 | ❌ 不计入 |
| 最小化浏览器窗口 | ❌ 不计入 |
| 锁屏状态 | ❌ 不计入 |
| 长时间无操作（>5分钟） | ❌ 不计入 |
| 视频静音播放 | ✅ 计入 |

### 5.2 文件完成判定规则

| 文件类型 | 完成条件 |
|---------|---------|
| PDF | `current_page >= total_pages` |
| 视频 | `current_time >= duration * 0.95` |

### 5.3 任务完成判定规则

```
无测验任务：所有文件完成 → 用户确认 → 任务完成
有测验任务：所有文件完成 + 测验通过 → 用户确认 → 任务完成
```

---

## 附录

### 相关文档

| 文档名称 | 描述 |
|---------|------|
| SRS-01-总体规格.md | 项目总体规格文档 |
| SRS-02-任务管理.md | 任务管理模块详细规格 |
| SRS-04-用户认证.md | 用户与认证模块详细规格 |
| SRS-05-测验考核.md | 测验考核模块详细规格 |
| SRS-06-报表统计.md | 报表统计模块详细规格 |
| UI-DESIGN.md | UI/UX 设计规范 |
